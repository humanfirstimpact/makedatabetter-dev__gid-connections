<!--
  Wrapper component for addConnection
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../gid-api/gid-api.html">
<!--
`gid-connections`

A data component to add/test/list a connections

This component covers three functionality. The details are listed below:

## Add Connection
        The field 'action' needs to set to 'ADD' in order to add a connection.

    <gid-connections action='ADD' api-url='https://ql50yzu0fj.execute-api.us-east-1.amazonaws.com/dev'
                            common-name='CRM@newton' connection-name='CRM' host='192.168.33.10' port='1521'
                            db-type='Oracle' db-user='globalids' password='globalids123'
                            application='CRM APP' lob='Enterprise'
                            api-token='MTAxNjUwMzAxMTUwNDUwNTg3NDkwODA5MDFY'
                            actionType='database' conn-response='{{response}}' conn-error="{{error}}>
        </gid-connections>


The fields 'action', 'common-name', 'connection-name', 'host', 'port', 'db-type', 'db-user', 'password', 'application' &
'lob' are mandatory.

The property 'conn-response' returns the response against the rest call.
The property 'conn-error' returns the error response against the rest call.

If 'apiUrl' is not provided, then the component would fetch sample data from mock json.

API endpoint:

   POST /add-connection
    
Input:
 api-url
 commonName
 connectionName
 host
 port
 dbType
 dbUser
 password
 application
 lob
 apiToken
 actionType
 connResponse
 connError

Sample Input: (Query params)

 ## Test Connection
        The field 'action' needs to set to 'TEST' in order to test a connection.

      <gid-connections action='TEST' api-url='https://ql50yzu0fj.execute-api.us-east-1.amazonaws.com/dev'
                            common-name='CRM@newton' connection-name='CRM' host='192.168.33.10' port='1521'
                            db-type='Oracle' db-user='globalids' password='globalids123'
                            application='CRM APP' lob='Enterprise'
                            api-token='MTAxNjUwMzAxMTUwNDUwNTg3NDkwODA5MDFY'
                            actionType='database' conn-response='{{response}}' conn-error="{{error}}>
        </gid-connections>


## List Connections
The field 'action' needs to set to 'LIST' in order to get the list of connections.

A data component to get list of connections and its metadata for given user id

    <gid-list-connections action="LIST" api-url='https://virtserver.swaggerhub.com/srimanta.maji/DISCOVERY/1' api-token={{api-token}}
    limit='[[limit]]' offset='[[offset]]' user='1' connections='{{connections}}'></gid-list-connections>

The property 'user' is mandatory.

The property 'connections' returns the response against the rest call.

- `limit`  & `offset` - use limit and offset parameters to paginate records


API endpoint:

    GET /databases

Input:

- User (Query param)

Output:

- List of connections with key metadata (items being displayed on listing page)


The output of this components will be as follows:

{
"databases": [
        {
            "id": "-3250952192666617532",
            "label": "CONSUMER_RELATIONSHIP",
            "connectionName": "CONSUMER_RELATIONSHIP",
            "host": "192.168.33.208",
            "port": 1530,
            "dbType": "Derby",
            "application": {
                "id": "102540266",
                "label": "Customer Mangement System"
            },
            "lob": {
                "id": "100850160",
                "label": "GLOBAL"
            }
        }
    ]
}

@demo demo/index.html
-->
<dom-module id="gid-connections">
    <template>
        <!-- fetch entity _path  -->
        <gid-api entity='{{_apiEntity}}' path-key='{{_pathKey}}' path='{{_path}}'></gid-api>
        <!--  fetch entity _path -->

        <!-- fetch concept details -->
        <gid-api id='gidConnAPI' auto=false
                 api-url={{_connUrl}}
                 response='{{_connResponse}}'
                 error='{{_connError}}'
                 request-body={{_connRequestBody}}
                 api-token={{_addConnToken}}
                 api-timeout={{_addConnTimeout}}></gid-api>
                 <!--method="POST" -->
                 <!--api-content-type="application/x-www-form-urlencoded" -->
    </template>
    <script>
        (function () {
            'use strict';
            Polymer({
                is: 'gid-connections',
                properties: {
                    /*Trigger to perform a specific action*/
                    actionType: {
                        type: String,
                        notify: true,
                        value: '',
                        observer: '_actionObserver'
                    },
                    /*Action to http method map object*/
                    _actionResultMap: {
                        type: Object,
                        value: {
                            "ADD": {"http": "POST", "contentType": "application/x-www-form-urlencoded"},
                            "TEST": {"http": "POST", "contentType": "application/x-www-form-urlencoded"},
                            "LIST": {"http": "GET", "contentType": "application/json"}
                        }
                    },
                    /*Authorization token for accessing rest api*/
                    apiToken: {
                        type: String,
                        notify: true,
                        value: ''
                    },
                    /*Base url*/
                    apiUrl: {
                        type: String,
                        notify: true,
                        value: ''
                    },
                    /*The api path*/
                    _path: {
                        type: String,
                        notify: true,
                        value: '',
                        observer: '_pathReceived'
                    },
                    /*The api path key*/
                    _pathKey: {
                        type: String,
                        notify: true,
                        value: ''
                    },
                    /*Api entity sent to gid-api*/
                    _apiEntity: {
                        type: String,
                        notify: true
                    },
                    /*User Id*/
                    user: {
                        type: String,
                        value: '',
                        notify: true
                    },
                    /*User id is stored here. This is a private property*/
                    owner: {
                        type: String,
                        notify: true,
                        value: ''
                    },

                    /*Array listing the body-parameters*/
                    _bodyParamsArr: {
                        type: Array,
                        value: ["commonName", "connectionName", "host", "port", "dbType", "dbUser", "password", "application", "lob"]
                    },
                    /*Array listing the query-param*/
                    _queryParamsArr: {
                        type: Array,
                        value: ["testConnection","limit","offset","filter"]
                    },
                    /*Parameter object*/
                    _paramsObj: {
                        type: Object,
                        notify: true,
                        value: {}
                    },
                    /*Request body sent to gid-api*/
                    _connRequestBody: {
                        type: Object,
                        notify: true,
                        value: {}
                    },
                    /*Url sent to gid-api*/
                    _connUrl: {
                        type: String,
                        notify: true
                    },
                    /*Response sent to gid-api.*/
                    _connResponse: {
                        type: Object,
                        notify: true,
                        observer: '_connResponseReceived'
                    },
                    /*Error sent to gid-api.*/
                    _connError: {
                        type: String,
                        notify: true,
                        observer: '_connErrorReceived'
                    },
                    /*Object for storing success response*/
                    connResponse: {
                        type: Object,
                        value: {},
                        notify: true
                    },
                    /*Object for storing error response*/
                    connError: {
                        type: Object,
                        value: {},
                        notify: true
                    },
                    commonName: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    connectionName: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    host: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    port: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    dbType: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    dbUser: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    password: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    application: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    lob: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    /*Limit parameter to paginate records*/
                    limit: {
                        type: String,
                        notify: true,
                        value: ''
                    },
                    /*Offset parameter to paginate records*/
                    offset: {
                        type: String,
                        notify: true,
                        value: ''
                    },
                    /*Parameters for filter*/
                    filter: {
                        type: String,
                        notify: true,
                        value: ''
                    },
                    /*set it true to test a connection*/
                    testConnection: {
                        type: Boolean,
                        notify: true,
                        value: false
                    },
                    /*Timeout sent to gid-api*/
                    _addConnTimeout: {
                        type: Number,
                        notify: true,
                        value: 0
                    },
                    /*Token sent to gid-api*/
                    _addConnToken: {
                        type: String,
                        notify: true
                    }
                },
                /* Reset method */
                _reset: function () {
                    this._apiEntity = '';
                    this._path = '';
                    this.actionType = "";

                },
                /* Observer of 'actionType' flag */
                _actionObserver: function () {
                    if (this.actionType) {
                        this.owner = this.user;
                        if (this.apiUrl) {
                            this._pathKey = 'default';
                            this._apiEntity = 'add-connection';
                        }
                    }
                },
                /* Observer for api path */
                _pathReceived: function () {
                    if (this._path && this._path.length > 0) {
                        var res = this._path.split(/{([^}]+)}/);
                        for (var i in res) {
                            if (!res[i].startsWith("/")) {
                                if (this[res[i]]) {
                                    res[i] = this[res[i]];
                                }
                            }
                        }
                        this._connUrl = this.apiUrl + res.join("");

                        for (var i in this._bodyParamsArr) {
                            if (this[this._bodyParamsArr[i]]) {
                                this._paramsObj[this._bodyParamsArr[i]] = this[this._bodyParamsArr[i]];
                            }
                        }
                        this._connRequestBody = JSON.stringify(this._paramsObj);

                        this._paramsObj={};
                        for (var i in this._queryParamsArr) {
                            if (this[this._queryParamsArr[i]]) {
                                this._paramsObj[this._queryParamsArr[i]] = this[this._queryParamsArr[i]];
                            }
                        }
                        this.$.gidConnAPI.apiParams = JSON.stringify(this._paramsObj);

                        if (this.apiToken) {
                            this._addConnToken = this.apiToken;
                        }

                        this.$.gidConnAPI.method = this._actionResultMap[this.actionType]["http"];
                        this.$.gidConnAPI.apiContentType = this._actionResultMap[this.actionType]["contentType"];

                        this._addConnTimeout = this._addConnTimeout - 1;

                    }
                },

                _connResponseReceived: function (newvalue, oldvalue) {
                    this._reset();
                    if (newvalue != null) {
                        this.async(function () {
                            this.dbResponse = newvalue.database;
                        }, 500);
                    }
                },

                _connErrorReceived: function (newvalue, oldvalue) {
                    this._reset();
                    if (newvalue !== null) {
                        this.async(function () {
                            this.connError = newvalue;
                        }, 500);
                    }
                }
            });
        })();
    </script>
</dom-module>
